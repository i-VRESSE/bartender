# Bartender

[![fair-software.eu](https://img.shields.io/badge/fair--software.eu-%E2%97%8F%20%20%E2%97%8F%20%20%E2%97%8B%20%20%E2%97%8F%20%20%E2%97%8B-orange)](https://fair-software.eu)

***

Bartender is a middleware web service to schedule jobs on various infrastructures.

This project was generated using [fastapi_template](https://github.com/s3rius/FastAPI-template).

## Step-by-step setup of proof-of-concept

1. Clone the repository

    ```bash
    git clone https://github.com/i-VRESSE/bartender.git
    cd bartender
    ```

2. Make a python virtual environment

    ```bash
    python3 -m venv venv
    source venv/bin/activate
    ```

3. Install poetry

    ```bash
    pip install poetry
    ```

4. Install dependencies

    ```bash
    poetry install
    ```

5. Run the database for storing users and jobs.

    Important: **In another terminal**

    ```bash
    docker run \
        -p "5432:5432" \
        -e "POSTGRES_PASSWORD=bartender" \
        -e "POSTGRES_USER=bartender" \
        -e "POSTGRES_DB=bartender" \
        postgres:13.6-bullseye
    ```

6. Create tables in the database

    ```bash
    alembic upgrade "head"
    ```

7. Run the application

    ```bash
    bartender serve
    ```

8. Go to the interactive API documentation generated by FastAPI

    <http://localhost:8000/api/docs>

    See [Consuming web service](#consuming-web-service) for more info.

## Project structure

```bash
$ tree .
├── tests                       # Tests for project.
│   └── conftest.py             # Fixtures for all tests.
├── docs                        # Documentatin for project.
|   ├── index.rst               # Main documentation page.
│   └── conf.py                 # Sphinx config file.
└── src
    └── bartender
        ├── db                  # module contains db configurations
        │   ├── dao             # Data Access Objects. Contains different classes to interact with database.
        │   └── models          # Package contains different models for ORMs.
        ├── __main__.py         # Startup script. Starts uvicorn.
        ├── services            # Package for different external services such as rabbit or redis etc.
        ├── settings.py         # Main configuration settings for project.
        ├── static              # Static content.
        └── web                 # Package contains web server. Handlers, startup config.
            ├── api             # Package with all handlers.
            │   └── router.py   # Main router.
            ├── application.py  # FastAPI application configuration.
            └── lifetime.py     # Contains actions to perform on startup and shutdown.
```

## Consuming web service

The interactive API documentation generated by FastAPI is at <http://localhost:8000/api/docs>

To consume the bartender web service you need to authenticate yourself.
Authentication is done by passing a JWT token in the HTTP header `Authorization: Bearer <token>` in the HTTP request.
This token can be aquired by using the register+login routes or using a [socal login](#user-management).

### Word count example

Bartender is by default configured with a word count applicaton.
Use the following steps to run a job:

1. Create an archive to submit. The zip file should contain a file called `README.md`. A zip file could be created in a clone of this repo with `zip README.zip README.md`.
2. Start [bartender web service and postgresql server](#step-by-step-setup-of-proof-of-concept)
3. Register & login account by
    1. Goto `http://127.0.0.1:8000/api/docs` and
    2. Try out the `POST /auth/register` route.
    3. Use default request body and press execute button. This will create an account with email `user@example.com` and password `string`.
    4. Use authorize button on top of page to login with username `user@example.com` and password `string`.
4. Submit archive.
    1. Try out the `POST /api/application/{application}/job` route.
    2. Use `wc` as application parameter
    3. Upload the `README.zip` as request body.
    4. Press execute button
    5. The response contains a job identifier (`id` property) that can be used to fetch the job state.
5. Fetch job state
    1. Try out the `GET /api/job/{jobid}`
    2. Use job identifier retrieved by submit request as `jobid` parameter value.
        * When job state is equal to `ok` the job was completed succesfully.
6. Retrieve result. The word count application (`wc`) outputs to the stdout.
    1. Try out the `GET /api/job/{jobid}/stdout`
    2. Use job identifier retrieved by submit request as `jobid` parameter value.
    3. Should see something like `433  1793 14560 README.md`.
        Where numbers are counts for newlines, words, bytes.

### Haddock3 example

To test with haddock3 use
```shell
export BARTENDER_APPLICATIONS='{"haddock3": {"command": "haddock3 $config", "config": "workflow.cfg"}}'
bartender serve
```
Bartender expects the haddock3 executable to be in its PATH.

Submit a job in another terminal in a directory with a zip file with a `workflow.cfg` file and its data files.

Examples at https://github.com/haddocking/haddock3/blob/main/examples .
```shell
curl -X 'PUT' \
  'http://127.0.0.1:8000/api/applications/haddock3/job' \
  -H 'accept: */*' \
  -H 'Content-Type: multipart/form-data' \
  -F 'upload=@docking-protein-protein.zip;type=application/x-zip-compressed'
```
Where `docking-protein-protein.zip` is the zip file to run haddock3 with.

The response contains a redirect to the job url (`/api/job/<some id>`).

The job url should be fetched until the state property is either `ok` or `error`.
