# bartender

[![fair-software.eu](https://img.shields.io/badge/fair--software.eu-%E2%97%8F%20%20%E2%97%8F%20%20%E2%97%8B%20%20%E2%97%8F%20%20%E2%97%8B-orange)](https://fair-software.eu)

- [bartender](#bartender)
  - [Step-by-step setup of proof-of-concept](#step-by-step-setup-of-proof-of-concept)
  - [Project structure](#project-structure)
  - [Consuming web service](#consuming-web-service)
    - [Word count example](#word-count-example)
    - [Haddock3 example](#haddock3-example)
  - [Poetry](#poetry)
  - [Docker](#docker)
  - [Pre-commit](#pre-commit)
  - [Migrations](#migrations)
    - [Reverting migrations](#reverting-migrations)
    - [Migration generation](#migration-generation)
  - [Running tests](#running-tests)
  - [Documentation](#documentation)
    - [Build](#build)

***

Bartender is a middleware web service to schedule jobs on various infrastructures.

This project was generated using [fastapi_template](https://github.com/s3rius/FastAPI-template).

## [Step-by-step setup of proof-of-concept](#step-by-step-setup-of-proof-of-concept)

1. Clone the repository

    ```bash
    git clone https://github.com/i-VRESSE/bartender.git
    cd bartender
    ```

2. Make a python virtual environment

    ```bash
    python3 -m venv venv
    source venv/bin/activate
    ```

3. Install poetry

    ```bash
    pip install poetry
    ```

4. Install dependencies

    ```bash
    poetry install
    ```

5. Run the database for storing users and jobs.

    Important: **In another terminal**

    ```bash
    docker run \
        -p "5432:5432" \
        -e "POSTGRES_PASSWORD=bartender" \
        -e "POSTGRES_USER=bartender" \
        -e "POSTGRES_DB=bartender" \
        postgres:13.6-bullseye
    ```

6. Create tables in the database

    ```bash
    alembic upgrade "head"
    ```

7. Run the application

    ```bash
    bartender serve
    ```

8. Go to the interactive API documentation generated by FastAPI

    <http://localhost:8000/api/docs>

    See [Consuming web service](#consuming-web-service) for more info.

## [Project structure](#project-structure)

```bash
$ tree .
├── tests                       # Tests for project.
│   └── conftest.py             # Fixtures for all tests.
├── docs                        # Documentatin for project.
|   ├── index.rst               # Main documentation page.
│   └── conf.py                 # Sphinx config file.
└── src
    └── bartender
        ├── db                  # module contains db configurations
        │   ├── dao             # Data Access Objects. Contains different classes to interact with database.
        │   └── models          # Package contains different models for ORMs.
        ├── __main__.py         # Startup script. Starts uvicorn.
        ├── services            # Package for different external services such as rabbit or redis etc.
        ├── settings.py         # Main configuration settings for project.
        ├── static              # Static content.
        └── web                 # Package contains web server. Handlers, startup config.
            ├── api             # Package with all handlers.
            │   └── router.py   # Main router.
            ├── application.py  # FastAPI application configuration.
            └── lifetime.py     # Contains actions to perform on startup and shutdown.
```

## [Consuming web service](#consuming-web-service)

The interactive API documentation generated by FastAPI is at <http://localhost:8000/api/docs>

To consume the bartender web service you need to authenticate yourself.
Authentication is done by passing a JWT token in the HTTP header `Authorization: Bearer <token>` in the HTTP request.
This token can be aquired by using the register+login routes or using a [socal login](#user-management).

### Word count example

Bartender is by default configured with a word count applicaton.
Use the following steps to run a job:

1. Create an archive to submit. The zip file should contain a file called `README.md`. A zip file could be created in a clone of this repo with `zip README.zip README.md`.
2. Start [bartender web service and postgresql server](#step-by-step-setup-of-proof-of-concept)
3. Register & login account by
    1. Goto `http://127.0.0.1:8000/api/docs` and
    2. Try out the `POST /auth/register` route.
    3. Use default request body and press execute button. This will create an account with email `user@example.com` and password `string`.
    4. Use authorize button on top of page to login with username `user@example.com` and password `string`.
4. Submit archive.
    1. Try out the `POST /api/application/{application}/job` route.
    2. Use `wc` as application parameter
    3. Upload the `README.zip` as request body.
    4. Press execute button
    5. The response contains a job identifier (`id` property) that can be used to fetch the job state.
5. Fetch job state
    1. Try out the `GET /api/job/{jobid}`
    2. Use job identifier retrieved by submit request as `jobid` parameter value.
        * When job state is equal to `ok` the job was completed succesfully.
6. Retrieve result. The word count application (`wc`) outputs to the stdout.
    1. Try out the `GET /api/job/{jobid}/stdout`
    2. Use job identifier retrieved by submit request as `jobid` parameter value.
    3. Should see something like `433  1793 14560 README.md`.
        Where numbers are counts for newlines, words, bytes.

### Haddock3 example

To test with haddock3 use
```shell
export BARTENDER_APPLICATIONS='{"haddock3": {"command": "haddock3 $config", "config": "workflow.cfg"}}'
bartender serve
```
Bartender expects the haddock3 executable to be in its PATH.

Submit a job in another terminal in a directory with a zip file with a `workflow.cfg` file and its data files.

Examples at https://github.com/haddocking/haddock3/blob/main/examples .
```shell
curl -X 'PUT' \
  'http://127.0.0.1:8000/api/applications/haddock3/job' \
  -H 'accept: */*' \
  -H 'Content-Type: multipart/form-data' \
  -F 'upload=@docking-protein-protein.zip;type=application/x-zip-compressed'
```
Where `docking-protein-protein.zip` is the zip file to run haddock3 with.

The response contains a redirect to the job url (`/api/job/<some id>`).

The job url should be fetched until the state property is either `ok` or `error`.

## [Poetry](#poetry)

This project uses [poetry](https://python-poetry.org/). It's a modern dependency management
tool.

To run the project use this set of commands:

```bash
poetry install
poetry run bartender serve
```

This will start the server on the configured host.

## [Docker](#docker)

You can start the project with docker using this command:

```bash
docker-compose -f deploy/docker-compose.yml --project-directory . up --build
```

If you want to develop in docker with autoreload add `-f deploy/docker-compose.dev.yml` to your docker command.
Like this:

```bash
docker-compose -f deploy/docker-compose.yml -f deploy/docker-compose.dev.yml --project-directory . up
```

This command exposes the web application on port 8000, mounts current directory and enables autoreload.

But you have to rebuild image every time you modify `poetry.lock` or `pyproject.toml` with this command:

```bash
docker-compose -f deploy/docker-compose.yml --project-directory . build
```

## [Pre-commit](#pre-commit)

[pre-commit](https://pre-commit.com/) is very useful to check your code before publishing it.
It's configured using `.pre-commit-config.yaml` file.

To install pre-commit simply run inside the shell:

```bash
pre-commit install
```

## [Migrations](#migrations)

Bartender uses [alembic](https://alembic.sqlalchemy.org) to create database tables and perform migrations.

If you want to migrate your database, you should run following commands:

```bash
# To run all migrations until the migration with revision_id.
alembic upgrade "<revision_id>"

# To perform all pending migrations.
alembic upgrade "head"
```

### Reverting migrations

If you want to revert migrations, you should run:

```bash
# revert all migrations up to: revision_id.
alembic downgrade <revision_id>

# Revert everything.
 alembic downgrade base
```

### Migration generation

To generate migrations you should run:

```bash
# For automatic change detection.
alembic revision --autogenerate

# For empty file generation.
alembic revision
```

## [Running tests](#running-tests)

If you want to run it in docker, simply run:

```bash
docker-compose -f deploy/docker-compose.yml --project-directory . run --rm api pytest -vv .
docker-compose -f deploy/docker-compose.yml --project-directory . down
```

For running tests on your local machine.

1. you need to start a database.

    I prefer doing it with docker:

    ```text
    docker run -p "5432:5432" -e "POSTGRES_PASSWORD=bartender" -e "POSTGRES_USER=bartender" -e "POSTGRES_DB=bartender" postgres:13.6-bullseye
    ```

2. Run the pytest.

    ```bash
    pytest -vv .
    ```

To get a PostgreSQL terminal do

```bash
docker exec -ti <id or name of docker container> psql -U bartender
```

## [Documentation](#documentation)

### Build

First install dependencies with

```shell
poetry install --with docs
```

Build with
```shell
cd docs
make html
```

Creates documentation site at [docs/_build/html](docs/_build/html/index.html).
